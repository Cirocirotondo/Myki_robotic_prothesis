%% load data
close all
clear
clc

numMag = 3;

offset = load('Offset_Acquisition_1706.txt');
offset = mean(offset);
data = load('3MMs_0mov_2acq_1706.txt');


Mf = data(1:3500,1:end-4);
Mf = Mf - offset(1:end-4);
%times = data(:,end-numMag:end);

clear data

%% Inizializzazioni varie

variables_DMsym

% Magnets parameters
D = 0.004; % Diameter of the magnets
H = 0.002; % Height of the magnets
M = 1.2706/(4*pi*1e-7); % Magnetization of the magnets [A/m]
m = M*((D/2)^2*pi*H);


% Magnets initial value
dx = 0.019;
dy = 0.004;
Mag_Position = [-0.023+dx 0.07+dy 0.072 0 0 1; 
                 0.02+dx 0.04+dy 0.062 1 0 0; 
                 0.025+dx 0.07+dy 0.072 -1 0 0; 
                -0.04+dx 0.045+dy 0.072 0 0 1;
                 0.015+dx 0.075+dy 0.04 0 0 1];
hold on
plot_mags(Mag_Position(1:3,:), 6, 'k', 'r', 'b');

             

%% gestione dati

B = cell(1,nPos);
B1 = cell(1,nPos);
x6 = cell(1,nPos);
for k = 1:nPos
%    load k-th line of data
    current_data = Mf(k,:);
    B{k} = zeros(3,128);            %B = 3*128 matrix -> prendo i dati dalla prima riga e li salvo nella matrice
    B{k}(1,:) = current_data(1:128)';
    B{k}(2,:) = current_data(129:256)';
    B{k}(3,:) = current_data(257:384)';

%    B1{k} = B{k};
%    B1{k}(:,1:32) = B{k}(:,33:64);
%    B1{k}(:,33:64) = B{k}(:,1:32);
  
    
%    plot
    %B = [-0.100722980073565,-0.105212434611479,-0.0891795011036506,-0.0548470343129648,0.00631488040154087,0.0637651371498212,0.0830139067918965,0.0643030999744864,-0.232380790322136,-0.300122980955571,-0.368061218402161,-0.389707068526667,-0.349945656719407,-0.292041941778077,-0.228732180342310,-0.176723889226719,-0.334505702661112,-0.446728990670361,-0.558023095761024,-0.637761495874162,-0.638114916953507,-0.604802128140738,-0.514781042459597,-0.410882216602118,-0.404924876419193,-0.544112450001883,-0.665158565251864,-0.742771639958073,-0.775633734293720,-0.749750465738010,-0.660015831408373,-0.536085459425382,0.152343794993194,0.0885135900789608,-0.0887281652230014,-0.377513837179714,-0.679594850496965,-0.837308024031019,-0.750204133659665,-0.558347815633671,0.0499946836915129,0.0281744002058633,-0.135233270982359,-0.378427191853458,-0.556140748248209,-0.590825343678799,-0.510123183419498,-0.386027098061049,-0.119915112932822,-0.147075036782509,-0.251598898183911,-0.381404535427524,-0.428394267090403,-0.383398451774614,-0.300531944967685,-0.235545623223873,-0.404208059920757,-0.470306981599880,-0.515308907071860,-0.502225605567473,-0.423867219528639,-0.312084818303522,-0.208962081477670,-0.152091209271032,0.211838645629660,0.103375069808713,-0.0298633818493371,-0.122937940244453,-0.190520162014629,-0.206474254009376,-0.251940959026365,-0.263777697811955,0.517250280371224,0.426820531572412,0.264875751783294,0.152876882561461,0.0942125049013801,0.0314790869320513,-0.0613132621581072,-0.161171499918135,0.785106239899083,0.757596504028605,0.630139661545335,0.558713332097873,0.569770522382436,0.500455086474247,0.278370328379043,0.0403536880162532,0.891485426964762,0.929899094200193,0.901176008391183,0.976622130869602,1.16879464962832,1.17045942956643,0.780310527350667,0.292084309337833,-0.400121873093191,0.0695086178142624,0.718413396085892,1.04402962138765,0.957271029015537,0.736753257885555,0.551329089178495,0.412853740950318,-0.200107022106413,0.368776333453807,1.08616151152806,1.41030049378089,1.27906947695635,0.979573759668526,0.731921266925816,0.540266519786759,0.0475334224043466,0.630552506762575,1.30914055660559,1.59074423696821,1.42180276628471,1.11464569696303,0.848244605554855,0.627600371875004,0.252920861545893,0.763422008383717,1.30580771129838,1.50617247397392,1.35923060705161,1.09412385800540,0.849542884297350,0.633682713909915;-0.828878415553424,-0.860213184693438,-0.666534288749097,-0.335294476403021,-0.00793095783508547,0.242047538808256,0.427608808146038,0.524446968033269,-0.797250895449992,-0.825186605065750,-0.654502722640350,-0.369980046635286,-0.0827049073543920,0.171012397952959,0.406437358136460,0.527628508728997,-0.718462529604856,-0.720001037028208,-0.567422033306698,-0.339411642229327,-0.120859915455112,0.112923721303036,0.322629500288368,0.445977552111978,-0.601831540286670,-0.593930077638444,-0.470439119049091,-0.296045696890526,-0.124186412498801,0.0564369481573279,0.215051883811645,0.317378546400954,0.194410754285434,-0.0353018212552754,-0.240722201818580,-0.406376646532182,-0.572354814886330,-0.709619942982733,-0.641932367440881,-0.429378558863732,0.188573039899555,-0.131880242845860,-0.472186906552399,-0.696562891787934,-0.768738237231117,-0.691995218636968,-0.490520818986859,-0.273477455857266,0.195108344731335,-0.203924242572138,-0.657811279477437,-0.872984326292368,-0.817731453768737,-0.633824768817514,-0.396485241557374,-0.204417699925934,0.170922460834972,-0.272899798862905,-0.737283832481109,-0.894640990228354,-0.756642885628979,-0.530641323445406,-0.324663159000706,-0.160557714270599,-0.0884578034024791,-0.192066219199091,-0.219647216076596,-0.205622287156859,-0.194931946901094,-0.207907824314002,-0.211083518052559,-0.182196747282245,-0.00779831088724022,-0.153057083954079,-0.216113667094723,-0.203793370843807,-0.220091135069352,-0.296674447742898,-0.348436094580560,-0.311202896634672,0.108383607205189,-0.0700008260668974,-0.132181691574086,-0.124043815755782,-0.187543110071773,-0.378943818011576,-0.542929098256502,-0.516701740233704,0.195601705848801,0.0616469731941112,0.0285908688885184,0.0519961473175517,-0.0777893843265444,-0.457986673678971,-0.758505399564214,-0.730427062069061,-0.698056801371614,-0.995821267044363,-0.872375589287477,-0.388318515457360,0.0153830010181928,0.204543379335715,0.269674213239277,0.284371188131777,-0.825176794277556,-1.09309921279879,-0.922086726714473,-0.352954696071394,0.104400497080919,0.312015514707819,0.375759385083897,0.370863848514187,-0.887974681763461,-1.10140264330409,-0.872741247076455,-0.305597654779084,0.152580660179196,0.361032468100659,0.420087689641812,0.424751404151872,-0.854361619014782,-0.979610119548060,-0.742614918714319,-0.254955275589701,0.146975538310306,0.340903165571662,0.417839098181543,0.420927538162539;0.346658598139982,0.789417189399525,1.21609406514399,1.42268248389937,1.43569723991971,1.32521351123460,1.09559639386820,0.838410972771780,0.296034656880613,0.710965695154061,1.08408614916112,1.29821835103812,1.37572054120846,1.32429733354459,1.14601324724666,0.860878940227619,0.231381005970706,0.567143081194985,0.861165822413652,1.03441166812349,1.11007960589483,1.10643693050792,0.973971414380133,0.737401691786114,0.108231032980570,0.372300866959456,0.589188456355782,0.698491495739893,0.743802412096728,0.747105268618305,0.670441683753379,0.529279095892680,0.882057542282783,0.945479870030448,0.904251967682825,0.800266737553802,0.626202990202907,0.316931765797131,-0.0382497602044959,-0.207543070925659,1.02991615391305,1.08924737896243,0.938126450207402,0.600264640078068,0.195982808556896,-0.182470501086338,-0.399149217256554,-0.417391866492048,1.16215005898303,1.26744521883218,1.02856695625341,0.507792048445760,0.0274763935348717,-0.304452407282034,-0.446315290597110,-0.434784638906923,1.14872538082610,1.27450446236503,0.958107857562486,0.384876312990157,-0.0889231395129157,-0.329552953169178,-0.415346024502630,-0.408062385300014,-0.605062885283418,-0.640688900568638,-0.639816629466534,-0.632873504355842,-0.612753896222922,-0.562287314095911,-0.465494592533211,-0.348537732648056,-0.637907706147172,-0.711016805233923,-0.762229467668623,-0.804211332046420,-0.829886183778609,-0.785876816375216,-0.651417211960106,-0.483546944609680,-0.474768884531382,-0.592648153962688,-0.706428114031970,-0.837821445246176,-0.952540647694635,-0.956917393846699,-0.795655955424418,-0.564829907794920,-0.202846910859288,-0.298033545163274,-0.450372895546843,-0.625652156267005,-0.800246220435903,-0.862598745693260,-0.718198660679657,-0.504035313145918,-0.500120755493678,-0.662295090676515,-0.811163304084496,-0.834680809042293,-0.756259813715577,-0.635049946984864,-0.509620417508980,-0.398170349189989,-0.510906879151837,-0.578811536202437,-0.616497302644933,-0.599096181162068,-0.542563947625725,-0.467935557806746,-0.386724398019923,-0.303099445418727,-0.438376989187224,-0.421042618681834,-0.332236527942706,-0.258036533156482,-0.216012557530679,-0.187890896261164,-0.182926546743258,-0.153601267515411,-0.262344935458008,-0.132783043909563,0.0386372892133497,0.150490173483802,0.145661598573896,0.0941360627847530,0.0466411634926963,0.0164928314769239];
    clf
    plot_multiple_boards(sPos, B{k}','k');
    if k == 1
        %x6{k} = localize_magnets([2 0 0 0 0 0; 0 1 0 0 0 0; 0 1 1 0 0 0], B{k}', nMag, m, sPos);     %first localization, starting from ground thruth
        x6{1} = Mag_Position(1:3,:);
    else
        x6{k} = localize_magnets(x6{k-1}, B{k}', nMag, m, sPos);
    end
    plot_mags(x6{k}, 6, 'r', 'g', 'y');      % original

    
    
    msg = "Fine ciclo n." + k;
    disp(msg);          
    pause(0.01);        
end


